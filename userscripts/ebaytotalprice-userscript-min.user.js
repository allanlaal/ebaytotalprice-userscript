// ==UserScript==
// @name         ebaytotalprice-userscript
// @namespace    https://github.com/subz390
// @version      2.2.0.210321235612
// @description  Add the total eBay auction price including postage in the auction listing
// @author       SubZ390
// @license      MIT
// @run-at       document-idle
// @grant        none
// @noframes
// @include      /^https?://(ar|b[ory]|c[lor]|do|ec|gt|hn|il|kz|mx|ni|p[aerty]|ru|sv|uy|ve|www)\.ebay\.com/
// @include      /^https?://www\.ebay\.com\.au/
// @include      /^https?://www\.ebay\.co\.uk/
// @include      /^https?://www\.ebay\.(at|ca|de|es|fr|ie|it|nl|ph|pl)/
// @include      /^https?://www\.be(nl|fr)\.ebay\.be/
//
//
// ==/UserScript==

function e(e,t=!0){if("object"!=typeof e)return typeof e;if(null===e)return"null";const n=Object.prototype.toString.call(e).slice(8,-1);return!0===t?n.toLowerCase():n}function t(t="",n,r=document){try{r=null===r?document:r;const n=e(t);if("string"==n){if(""==t)return null;let n=e(r);if("text"==n)return null;if("string"==n){const e=document.querySelector(r);if(null==e)return null;r=e}return n=e(r),-1!==n.search(/array|nodelist|html/i)?r.querySelector(t):null}return-1!==n.search(/array|nodelist|html/i)?t:null}catch(e){console.error(e)}}function n(e,t,n=1){if(null===e)return null;const r=e.match(t);return r?"all"==n?r:r[n]?r[n]:r[0]:null}function r({selector:e=null,scope:n=document,t:r=!1,all:i=!1,contains:l=null,i:o=!1,l:c=""}={}){const s={o:{u:`${c}selector is undefined`,p:`${c}scope is not useable`}};if("language"===o)return s;try{if(null===e)return console.error(s.o.u),null;if(n!==document&&null===(n=t(n)))return null;if("scope"===o)return n;if("options"===o)return{selector:e,scope:n,t:r,all:i,contains:l,i:o};if(!0===i){const t=n.querySelectorAll(e);if(0===t.length)return null;if(!0===r){if(null!==l){const e=[];return t.forEach((t=>{-1!==t.textContent.search(l)&&e.push(t)})),0===e.length?null:e}return Array.from(t)}if(null!==l){for(let e=0;e<t.length;e++)if(-1!==t[e].textContent.search(l))return t;return null}return t}{const t=n.querySelector(e);return null===t||("string"==typeof l||l instanceof RegExp)&&-1===t.textContent.search(l)?null:!0===r?[t]:t}}catch(e){console.error(e)}}function i(...t){if(0==Object.keys(t).length)return null;if(""===t[0])return null;const n=((t,n,r,i)=>{let l,o,c,s;if("object"===e(t)){function u(e,t){const n=t.find((t=>e.hasOwnProperty(t)));return void 0!==n?e[n]:void 0}o=u(t,["option","options","property","props","properties"]),l=u(t,["object"]),s=u(t,["default"]),c=u(t,["action","callback"])}else o=t,s=void 0,c=void 0;if(void 0===o)return s;if("string"==typeof c&&"set"===c)return s;function a(e,t,n={}){return"function"==typeof t?t(e,n):e}if("object"===e(l)){if("array"===e(o)){for(let e=0;e<o.length;e++)if(l.hasOwnProperty(o[e])){const t=a(l[o[e]],c,l);if(void 0!==t)return t}}else if("string"==typeof o&&l.hasOwnProperty(o)){const e=a(l[o],c,l);if(void 0!==e)return e}}else if("array"===e(o)){for(let e=0;e<o.length;e++)if(void 0!==o[e]){const t=a(o[e],c,l);if(void 0!==t)return t}}else{const e=a(o,c,l);if(void 0!==e)return e}return s})({options:["object"==e(t[0])?t[0]:void 0],default:{m:/{([^{}]+)}/g,S:t[0]}});return"object"==e(t[1])?n.S.replace(n.m,((e,n)=>{for(let e=1;t[e];e++){if("string"==typeof t[e][n]&&0==t[e][n].length)return"";if(t[e][n])return"function"==typeof t[e][n]?t[e][n]().toString():t[e][n]}return e})):n.S.replace(n.m,((e,n)=>t[n]||e))}const l=/((\d+[,\.])+\d+)/,o=/((((AU|C|US) )?\$)|EUR|PHP|zł|£)/;function c(e){try{let t=n(e.textContent.trim(),l);return t=t.replace(/[,\.]/g,""),t=parseFloat(t),t}catch(e){return console.error(e),null}}function s({g:e,v:t,h:l=null,P:s,I:u=null}){const a=r({selector:e,all:!0,t:!0});if(a)for(let e=0;a[e];e++){const p=r({selector:t,scope:a[e]}),m=r({selector:s,scope:a[e],contains:/\d/});if(p&&m){const e=n(p.textContent.trim(),o),t=n(m.textContent.trim(),o);if(t&&t===e){const e=((c(p)+c(m))/100).toFixed(2),n=i(u||l,{itemPrice:p.textContent.trim(),itemShippingAmount:m.textContent.trim(),currencySymbol:t,totalPrice:e});l?p.insertAdjacentHTML("afterend",n):m.innerHTML=n}}}}(({style:e,className:n,T:r="afterend",j:i="body",C:l=5,_:o})=>{new Promise(((c,s)=>{const u=document.createElement("style");u.appendChild(document.createTextNode(e)),n&&(u.className=n),(({C:e=3,every:t=100,test:n=(()=>!1),A:r=(()=>null),timeout:i=(()=>null)}={})=>{if(!1===(()=>{const e=n();return!!e&&(r(e),!0)})()){const l=setInterval((()=>{const e=n();e&&(clearInterval(l),clearTimeout(o),r(e))}),t),o=setTimeout((()=>{clearInterval(l),i()}),1e3*e)}})({C:l,every:100,test:()=>t(i),A(e){c(((e,t)=>void 0!==r?e.insertAdjacentElement(r,t):e.appendChild(t))(e,u))},timeout:()=>s(Error(o||`appendStyle timed out whilst waiting for targetNode: ${i}`))})}))})({style:".total-price{background:#bf0;color:#f00!important;outline:2px solid;padding:1px 4px;margin-left:5px;font-size:20px!important;font-weight:400!important;}.s-item__detail{overflow:visible!important;}"}),(e=>{try{const n=(()=>{for(const[,n]of Object.entries(e))for(let e=0;e<n.U.length;e++)if(null!==t(n.U[e]))return n;return null})();null!==n&&n.process()}catch(e){console.error(e)}})({search:{U:["#mainContent ul.srp-results","#mainContent ul.b-list__items_nofooter"],process:()=>s({g:"#mainContent li.s-item",v:".s-item__price",P:".s-item__shipping",h:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})},F:{U:["#mainContent ul#ListViewInner"],process:()=>s({g:"#mainContent li",v:".lvprice span",P:".lvshipping span.fee",h:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})},$:{U:['#mainContent form[name="viactiondetails"]'],process:()=>(({g:e,v:t,N:l,h:s=null,P:u,O:a,I:p=null})=>{const m=r({selector:e});if(m){const e=r({selector:l,scope:m,contains:/\d/})||r({selector:t,scope:m,contains:/\d/}),f=r({selector:a,scope:m,contains:/\d/})||r({selector:u,scope:m,contains:/\d/});if(e&&f){const t=n(e.textContent.trim(),o),r=n(f.textContent.trim(),o);if(r&&r===t){const t=((c(e)+c(f))/100).toFixed(2),n=i(p||s,{itemPrice:e.textContent.trim(),itemShippingAmount:f.textContent.trim(),currencySymbol:r,totalPrice:t});s?e.insertAdjacentHTML("afterend",n):f.innerHTML=n}}}})({g:"#mainContent",v:'span[itemprop="price"]',N:"#prcIsumConv",P:"#fshippingCost",O:"#convetedPriceId",h:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})}});
